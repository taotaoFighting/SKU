<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">

		<link rel="stylesheet" href="css/mui.min.css">
		<style>
			html,body {
				background-color: #efeff4;
			}
			.title{
				margin: 20px 15px 10px;
				color: #6d6d72;
				font-size: 15px;
			}
		</style>
	</head>

	<body>
		<div class="mui-content">
			<div style="text-align: center;margin-top: 1%;">
				<img id="headerImage" style="width: 30%;height: 30%;border-radius:50%" src="images/user-photo.png"/>
			</div>
			<ul class="mui-table-view">
				<li class="mui-table-view-cell">
					<a class="">
						账号
						<span id="accountName" style="margin-left: 40%;">
							xyu20897
						</span>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a class="">
						姓名
						<span id="name" style="margin-left: 40%;">
							测试账号
						</span>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="tel" class="mui-navigate-right">
						手机号
						<span id="phoneNumber" style="margin-left: 35%;">
							15093455345
						</span>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="sign">
						是否提示签到
						<div id="sign" class="mui-switch mui-switch-mini mui-active">
						  	<div class="mui-switch-handle"></div>
						</div>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="clearCache" class="mui-navigate-right">
						清除缓存
						<span id="totalCache" style="margin-left: 55%;">
							0.0M
						</span>
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a id="settingPassword" class="mui-navigate-right">
						设置密码
					</a>
				</li>
				<li class="mui-table-view-cell">
					<a class="mui-navigate-right" id="sku_about">
						关于巡店
					</a>
				</li>
			</ul>
				
			<ul class="mui-table-view" style="margin-top: 25px;">
				<li class="mui-table-view-cell">
					<a id="logout" style="text-align: center;color: #FF3B30;">
						退出登录
					</a>
				</li>
			</ul>
		</div>
		</style>
	</body>
	<script src="js/mui.min.js"></script>
	<script src="./resources/jquery-2.1.3.js"></script>
	<script>
		mui.init({
			swipeBack:false //启用右滑关闭功能
		});
		
		document.getElementById("headerImage").addEventListener('tap',function () {
			 
			 if(mui.os.plus){
			 	
			 	 var a = [{ 
			        title: "拍照" 
			    }, { 
			        title: "从手机相册选择" 
			    }];
			 	plus.nativeUI.actionSheet({
			 		title:"修改头像",
			 		cancel:"取消",
			 		buttons:a
			 	},function(b){
			 		 switch(b.index) { 
				        case 0: 
				            break; 
				        case 1: 
				            getImage(); /*拍照*/ 
				            break; 
				        case 2: 
				            galleryImg(); /*打开相册*/ 
				            break; 
				        default: 
				            break; 
				        }
			 	})
			 }
		},false);
		
		document.getElementById("clearCache").addEventListener('tap',function () {
			var btnArray = ['否', '是'];
			mui.confirm('确定清除缓存？', '清除缓存', btnArray, function(e) {
				if (e.index == 1) {
					alert("确定");
				} else {
					alert("取消")
				}
			})
		});
		document.getElementById("logout").addEventListener('tap',function () {
			
			localStorage.removeItem("firstLaunch");
			 plus.runtime.restart();
		});
		document.getElementById("tel").addEventListener('tap',function () {
			 mui.openWindow({
					    url: 'sku-tel.html', 
					    id:'tel',
					  });
		});
		document.getElementById("settingPassword").addEventListener('tap',function () {
			 mui.openWindow({
					    url: 'sku-settingPassword.html', 
					    id:'settingPassword',
					  });
		});
		document.getElementById("sku_about").addEventListener('tap',function () {
			 mui.openWindow({
				url: 'sku-about.html', 
				id:'about',
				styles:{
//  				popGesture:'none'	
    			}
			});
		});
		
		window.addEventListener('tab-webview-subpage-setting.html',function(event){
		  //获得事件参数
		 $('#phoneNumber').html(event.detail.tel);
		}); 
		//拍照 
		function getImage() { 
		    var cmr = plus.camera.getCamera(); 
		    var res = cmr.supportedImageResolutions[0]; 
		    var fmt = cmr.supportedImageFormats[0]; 
		    cmr.captureImage(function(path) { 
		        //plus.io.resolveLocalFileSystemURL(path, function(entry) {   
		    plus.io.resolveLocalFileSystemURL(path, function(entry) { 
		        var localUrl = entry.toLocalURL(); 
		        var e = localUrl + "?version=" + new Date().getTime();
		         $('#headerImage').attr('src',e);
		       	/* uploadHead(e); 上传图片*/
		    }, function(err) { 
		        console.error("拍照失败：" + err.message); 
		    }, { 
		        index: 1 
		    }); 
		    }); 
		}  
		//本地相册选择 
		function galleryImg() { 
		    plus.gallery.pick(function(a) { 
		    plus.io.resolveLocalFileSystemURL(a, function(entry) { 
		        plus.io.resolveLocalFileSystemURL("_doc/", function(root) { 
		        root.getFile("head.png", {}, function(file) { 
		            //文件已存在 
		            file.remove(function() { 
		            console.log("file remove success"); 
		            entry.copyTo(root, 'head.png', function(e) { 
		                var e = e.fullPath + "?version=" + new Date().getTime(); 
		                /*uploadHead(e); 上传图片*/ 
		                //变更大图预览的src 
		                //目前仅有一张图片，暂时如此处理，后续需要通过标准组件实现 
		                console.log('path = '+e)
						$('#headerImage').attr('src',e);
		                },function(e) { 
		                    console.log('copy image fail:' + e.message); 
		            }); 
		            }, function() { 
		            		console.log("delete image fail:" + e.message); 
		            }); 
		        }, function() { 
		            //文件不存在 
		            entry.copyTo(root, 'head.png', function(e) { 
		            var path = e.fullPath + "?version=" + new Date().getTime(); 
		            uploadHead(path); /*上传图片*/ 
		            },function(e) { 
		            console.log('copy image fail:' + e.message); 
		            }); 
		        }); 
		        }, function(e) { 
		        console.log("get _www folder fail"); 
		        }) 
		    }, function(e) { 
		        console.log("读取拍照文件错误：" + e.message); 
		    }); 
		    }, function(a) {}, { 
		    filter: "image" 
		    }) 
		}; 
		 
		//上传头像图片  
		function uploadHead(imgPath) { 
		    var image = new Image(); 
		    image.src = imgPath; 
		    image.onload = function() { 
		    var imgData = getBase64Image(image); 
		    console.log(imgData); 
		    /*在这里调用上传接口*/ 
		    //mui.ajax("图片上传接口", { 
		        //data: { 
		        //img: imgData 
		        //}, 
		        //dataType: 'json', 
		        //type: 'post', 
		        //timeout: 10000, 
		        //success: function(data) { 
		        //mui.toast('上传成功',{ 
		            //duration:'long', 
		            //type:'div' 
		        //}); 
		                //document.getElementById('head-img').src = imgPath; 
		        //document.getElementById('head-img1').src = imgPath; 
		        //document.getElementById('head-img2').src=imgPath; 
		        //},  
		            //error: function(xhr, type, errorThrown) { 
		        //mui.toast('网络异常，请稍后再试！'); 
		        //} 
		    //}); 
		    } 
		} 
		//将图片压缩转成base64 
		function getBase64Image(img) { 
		    var canvas = document.createElement("canvas"); 
		    var width = img.width; 
		    var height = img.height; 
		    // calculate the width and height, constraining the proportions 
		    if(width > height) { 
		    if(width > 100) { 
		        height = Math.round(height *= 100 / width); 
		        width = 100; 
		    } 
		    } else { 
		    if(height > 100) { 
		        width = Math.round(width *= 100 / height); 
		        height = 100; 
		    } 
		    } 
		    canvas.width = width; /*设置新的图片的宽度*/ 
		    canvas.height = height; /*设置新的图片的长度*/ 
		    var ctx = canvas.getContext("2d"); 
		    ctx.drawImage(img, 0, 0, width, height); /*绘图*/ 
		    var dataURL = canvas.toDataURL("image/png", 0.8); 
		    return dataURL.replace("data:image/png;base64,", ""); 
		} 
	</script>
</html>